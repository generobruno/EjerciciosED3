/*
===============================================================================
 Name        : EjTimerMatch5_Genero.c
 Author      : Bruno A. Genero
 Description : Utilizando los 4 registros match del Timer 0 y las salidas
 P0.0, P0.1, P0.2 y P0.3, realizar un programa en C que permita obtener
 las formas de ondas adjuntas, donde los pulsos en alto tienen una
 duración de 5 mseg. Un pulsador conectado a la entrada EINT3, permitirá
 elegir entre las dos secuencias mediante una rutina de servicio a la
 interrupción. La prioridad de la interrupción del Timer tiene que ser
 mayor que la del pulsador. Estas formas de ondas son muy útiles para
 controlar un motor paso a paso. Adjuntar el código en C.
===============================================================================
*/

#include "LPC17xx.h"

void confTimer(void);
void confGPIO(void);
void confInt(void);
void parMenor(void);
void parMax(void);

int main(void) {

	confGPIO();
	confTimer();
	confInt();

    while(1) {
    }
    return 0 ;
}

/**
 * Configura el timer para realizar la secuencia del
 * par menor por el puerto 0.
 */
void parMenor(void) {
	// Desactivamos el timer para poder reconfigurarlo
	if((LPC_TIM0->TCR) & (1<<0)) {
		LPC_TIM0->TCR = 3;
	}

	// Configuramos los Matches
	LPC_TIM0->MR0 = 0x7A11F;	// 5 ms
	LPC_TIM0->MR1 = 0xF423F;	// 10 ms
	LPC_TIM0->MR2 = 0x16E35F;	// 15 ms
	LPC_TIM0->MR3 = 0x1E847F;	// 20 ms
	// Hacemos que se reinicie con MR3
	LPC_TIM0->MCR |= (1<<10);

	// Volvemos a habilitar el timer
	LPC_TIM0->TCR &= ~(1<<1);
	return;
}

void parMayor(void) {

}

void confGPIO(void) {
	// Configuramos los pines P0.0 a P0.3 como salida
	LPC_GPIO0->FIODIR0 |= (15<<0);
	return;
}

void confTimer(void) {
	// El timer 0 ya esta siendo alimentado por reset
	// pclk = cclk
	LPC_SC->PCLKSEL0 |= (1<<2);
	// Cargamos los valores de match (par menor predet, pckl = 100MHz)
	parMenor();
	// Habilitamos el timer
	LPC_TIM0->TCR = 3;
	LPC_TIM0->TCR &= ~(1<<1);
	return;
}

void confInt(void) {
	// Configuramos pin P2.13 como EINT3
	LPC_PINCON->PINSEL4 |= (1<<26);
	// EINT3 por flanco de bajada
	LPC_SC->EXTMODE |= (1<<3);
	LPC_SC->EXTPOLAR &= ~(1<<3);
	LPC_SC->EXTINT |= (1<<3);
	// Habilitamos la interrupcion
	NVIC_EnableIRQ(EINT3_IRQn);
	return;
}
